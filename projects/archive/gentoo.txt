===== Gentoo Linux =====

Gentoo is my distro of choice since more than 7 years. It's about time for me to become a developer but who has the time to take all those tests ... :).

===== My Portage layout =====

General ideas:
   * Files are placed according to FHS rules
   * /var/cache is used to place files which are cached (ebuilds synchronized with remote repos, downloaded source files, paludis caches)
   * /var/lib/portage is used for variable portage-specific files (world file, installed VDB repository, unpackaged installed repository)
   * The /var/db/pkg is a symlink for legacy reasons

Files under /var/cache

^ Location                       ^ Purpose    ^ Portage variable ^
| /var/cache/src                 | Location of downloaded sources (distfiles) | DISTDIR |
| /var/cache/ebuild/$REPO        | Location of ebuild files for each configured repository (overlay) | |
| /var/cache/ebuild/gentoo       | Main Gentoo ebuild repository | PORTDIR |
| /var/cache/ebuild/cpan         | The repository for ebuilds generated by g-cpan (Perl modules from CPAN) | GCPAN_OVERLAY |
| /var/cache/ebuild/crossdev     | The repository for ebuilds generated by crossdev (Cross-compiler toolchains) | CROSSDEV_OVERLAY |
| /var/cache/paludis/*           | Paludis caches | |
| /var/cache/paludis/names       | names cache | |
| /var/cache/paludis/metadata    | metadata cache | |
| /var/cache/paludis/provides    | provides cache | |
| /var/cache/paludis/unavailable | The information downloaded as part of the 'unavailable' layman repository | |

Files under /var/lib/portage

^ Location                    ^ Purpose    ^
| /var/lib/portage/world      | World file | 
| /var/lib/portage/installed  | Default VDB repository |
| /var/lib/portage/unpackaged | installed-unpackaged repository location |


Paludis & portage configuration files dump is below (except use.conf, which is boring and has a lot of churn). Make.conf is minimal:

<file>
# These settings were set by the catalyst build script that automatically
# built this stage.
# Please consult /etc/make.conf.example for a more detailed example.
CFLAGS="-O2 -pipe"
CXXFLAGS="-O2 -pipe -march=nocona"
# WARNING: Changing your CHOST is not something that should be done lightly.
# Please consult http://www.gentoo.org/doc/en/change-chost.xml before changing.
CHOST="x86_64-pc-linux-gnu"
# These are the USE flags that were used in addition to what is provided by the
# profile used for building.
USE="mmx sse sse2"

LDFLAGS="-Wl,--as-needed"
MAKEOPTS="-j3"

GENTOO_MIRRORS="http://gentoo.mirror.pw.edu.pl"
ACCEPT_KEYWORDS="~amd64"

USE="visibility"

DISTDIR="/var/cache/src"
PORTDIR="/var/cache/ebuild/gentoo"
PKGDIR="/var/lib/portage/binpkg"

GCPAN_OVERLAY="/var/cache/ebuild/cpan"

CROSSDEV_OVERLAY="/var/cache/ebuild/crossdev"
</file>

As you can see it contains mainly file location definitions pointing them from legacy directories to the new scheme (DISTDIR, PORTDIR, etc.). The main package manager used on the host is Paludis, therefore much more configuration is available for it. I'm deliberately skipping keywords.conf, licences.conf, packages_*mask.conf and use.conf as they are not really interesting.

First, the general.conf links us to the "world set" file location:

general.conf
<file>
world=${root}/var/lib/portage/world
reduced_username=portage
</file>

The repository default settings file contains common values for all repositories. By setting the location for each repo you don't need to have redundant location= everywhere in /etc/paludis/repositories. Everything is cleanly generated from the repository file name. Also, all the caches are kept in one place (in /var/cache/paludis mentioned before).

repository_defaults.conf
<file>
# Setup all the caches in one place
names_cache = ${root}/var/cache/paludis/names
write_cache = ${root}/var/cache/paludis/metadata
provides_cache = ${root}/var/cache/paludis/provides

# Locate all ebuilds in /var/cache/ebuild
location = ${root}/var/cache/ebuild/${repo_file_unsuffixed}

distdir = ${root}/var/cache/src
</file>

The following template file is used by the 'repository' type repository when requesting a repository installation. Please refer to [[http://paludis.exherbo.org/configuration/repositories/repository.html|Paludis documentation]] for a description on how this works in detail.

repository.template
<file>
format = %{repository_template_format}
sync = %{repository_template_sync}
</file>

There are two mandatory repositories in Gentoo which require special configuration:

repositories/gentoo.conf
<file>
sync = rsync://mirror.bytemark.co.uk/gentoo-portage/ rsync://gentoo.prz.rzeszow.pl/gentoo-portage rsync://mirrors.tera-byte.com/gentoo-portage
profiles = ${location}/profiles/default/linux/amd64/10.0/desktop
format = e
</file>

repositories/installed.conf
<file>
location = ${root}/var/lib/portage/installed
format = vdb
</file>

Another set of useful repository types is implemented in Paludis:

repositories/repository.conf
<file>
format = repository
config_template = ${root}/etc/paludis/repository.template
config_filename = ${root}/etc/paludis/repositories/%{repository_template_name}.conf
</file>

repositories/installed_unpackaged.conf
<file>
format = installed_unpackaged
location = ${root}/var/lib/portage/unpackaged
</file>

The configuration for repositories containing ebuilds generated automatically by external tools (like g-cpan) is trivially simple:

repositories/cpan.conf
<file>
format = e
</file>

repositories/crossdev.conf
<file>
format = e
</file>


#+TITLE: Second Life UPS Mark II

* Introduction

The Secondlife UPS Mark II was envisioned as a successor to the first [[file:secondlife-ups.org]] model with the general changes as below

- increased battery capacity
- increased power budget
- circuit simplification
- modularity
- improved load connectors
- various other usability improvements (for example moving the fuses to the front of the enclosure)
- better documentation 

The basic premise is to provide a short depth (~25 mm) rack mountable UPS which instead of 230V AC can provide typical low voltages suitable for 
powering of CCTV cameras, sensors, routers, 802.11 access points modems, switches, embedded systems (like a Raspberry Pi) and other small devices. 
This approach is advantegous both in terms of saving rack space where a PDU does not have to be mounted as well as potential power efficiency savings 
of having fewer AC <-> DC power conversion steps.

The UPS design is focused around a few stabilised voltage buses providing 12V and 5V respectively as well as a "direct" rail (labelled later as V_rail)
which is connected directly to the battery or AC power supply. The peculiarity of this bus is that the voltage on it has a significant swing - from 11.2V 
when operating on an almost depleted battery towards 24V when operating on AC power.

*** More battery capacity

In order to provide more power as well as longer runtime, the UPS will contain Lithium-Ion battery pack with a 4S24P layout build from refurbished 18650 cells
with a capacity of around 300 Wh. All of the components will be housed in a chassis from a damaged [[https://wikidevi.wi-cat.ru/Netgear_GS748T_v4][Netgear GS748T]] switch disposed of for recycling.

*** More power capacity

The list of equipment in my home rack has changed, some equipment has been replaced, there is some new equipment as well. Some of the new equipment
will be powered by wide input range DC-DC converters so they can be powered directly from the battery rail (V_rail). I measured the amount of current draw
during normal operation for each piece of equipment and came up with the following calculations for the power budget requirements of the UPS. As the voltage 
on the V_rail bus is not constant and changes from 11.2V when operating on a discharged battery and 24V when operating on AC its more useful to specify 
it's performance in terms of power not current.

#+CAPTION: Devices connected to the UPS
#+ATTR_HTML: :border 2 :rules all :frame border
#+NAME: devices
|-----------------------------+----------------------------+-----------------------+----------------------+-----------------------------+------------------------+-----------------------------------------------------------------------------------------------------------|
| Device                      | 12V Current [A] (measured) | 12V Current [A] (max) | 5V Current [A] (max) | V_rail power [W] (measured) | V_rail power [W] (max) | Notes                                                                                                     |
|-----------------------------+----------------------------+-----------------------+----------------------+-----------------------------+------------------------+-----------------------------------------------------------------------------------------------------------|
| Router                      |                            |                     5 |                      |                             |                        | Axiomtek NA342                                                                                            |
| GPON Modem                  |                            |                   0.5 |                      |                             |                        |                                                                                                           |
| Core Ethernet switch        |                       1.33 |                     4 |                      |                             |                        |                                                                                                           |
| Planet GSD-800S switch      |                            |                       |                      |                             |                     21 | PoE injected                                                                                              |
| Ubiquity Unify AC Lite AP   |                       0.16 |                  0.54 |                      |                             |                        | Via boost converter and PoE injected, rated at 6.5 W (see [[https://dl.ui.com/datasheets/unifi/UniFi_AC_APs_DS.pdf][datasheet]]), passive 24V PoE Mode B (230V/0.02A) |
| Raspberry Pi                |                            |                       |                  2.1 |                             |                        |                                                                                                           |
| Gate magnetic lock          |                       0.25 |                       |                      |                             |                        |                                                                                                           |
| [[https://wikidevi.wi-cat.ru/Netgear_ReadyNAS_3138][Network Attached Storage]]    |                            |                       |                      |                          40 |                    100 | Built-in ATX power supply is 180W but real power draw has not exceeded 100W                               |
| Network Video Recorder      |                            |                       |                      |                             |                     40 | Boost converter to 48V                                                                                    |
| Security Cameras (total)    |                       0.75 |                       |                      |                             |                        |                                                                                                           |
| Miscelaneous (ie. rack fan) |                            |                   0.5 |                  0.5 |                             |                        |                                                                                                           |
|-----------------------------+----------------------------+-----------------------+----------------------+-----------------------------+------------------------+-----------------------------------------------------------------------------------------------------------|
| Total                       |                       2.49 |                 10.54 |                  2.6 |                          40 |                    161 |                                                                                                           |
|-----------------------------+----------------------------+-----------------------+----------------------+-----------------------------+------------------------+-----------------------------------------------------------------------------------------------------------|
#+TBLFM: @>$2=vsum(@II..@III)::@>$3=vsum(@II..@III)::@>$4=vsum(@II..@III)::@>$5=vsum(@II..@III)::@>$6=vsum(@II..@III)

*** Capacity planning for power buses

We take into account an efficiency of 0.8 for the buck converters and assume that the lowest battery voltage will be 11.2V which corresponds to the BMS cutoff voltage of 
2.8V per cell (11.2V = 3 * 2.8V).

#+CAPTION: Maximum current and power values for each bus
#+NAME: bus_load_capacity
|---+-------------------------------+-------------+-----------------+---------------+-------------------------------+-----------------------------|
| $ | minimum_battery_voltage=11.2  |             |                 |               |                               |                             |
| $ | voltage_on_ac=24              |             |                 |               |                               |                             |
| $ | buck_converter_efficiency=0.8 |             |                 |               |                               |                             |
|---+-------------------------------+-------------+-----------------+---------------+-------------------------------+-----------------------------|
|   | Bus                           | Voltage [V] | Max current [A] | Max power [W] | V_rail load on batt power [A] | V_rail load on AC power [A] |
|---+-------------------------------+-------------+-----------------+---------------+-------------------------------+-----------------------------|
| # | 12 V                          |          12 |           10.54 |        126.48 |                     14.116071 |                        5.02 |
| # | 5 V                           |           5 |             2.6 |           13. |                     1.4508929 |                      0.4375 |
| # | Direct                        |             |                 |           161 |                        14.375 |                   6.7083333 |
|---+-------------------------------+-------------+-----------------+---------------+-------------------------------+-----------------------------|
| # | Total                         |             |                 |        300.48 |                     29.941964 |                   12.165833 |
|---+-------------------------------+-------------+-----------------+---------------+-------------------------------+-----------------------------|
#+TBLFM: @5$4=remote(devices, @>$3)::@6$4=remote(devices, @>$4)::@7$5=remote(devices, @>$6)
#+TBLFM: @5$5=$3 * $4::@6$5=$3 * $4::$7=$5 / $voltage_on_ac
#+TBLFM: @5$6=$-1 / $buck_converter_efficiency / $minimum_battery_voltage::@6$6=$-1 / $buck_converter_efficiency / $minimum_battery_voltage::@7$6=$-1 / $minimum_battery_voltage
#+TBLFM: @>$5=vsum(@III..@IIII)::@>$6=vsum(@III..@IIII)

All of the above calculations allow us to select:

- internal wiring diameter
- internal and external connectors
- proper fuses
- buck converter maximum power and current
- AC power supply maximum power and current

It can be seen that an AC power supply with at least 300W is needed to power the loads with some room needed to charge the battery. For this reason a 400W power 
supply has been selected (see summary in BOM).

*** Ideal Diode circuit

Instead of the previously used relay-based power path switching scheme a solid-state power switch based on MOSFETs driven by the LTC4416 PowerPath controller will be used.

*** Battery pack 

*** Modularity

**** Fanout boards and fuse boards

**** Improved load connectors


* Overall schematics
[[file:secondlife-ups-MkII/hw.svg]]

* Build instructions

** Planning

-- photo of first layout of internal components --
   
[[file:secondlife-ups-MkII/initial-placement.jpg][file:secondlife-ups-MkII/thumb-initial-placement.jpg]]

** Enclosure preparation
*** Stud removal
- photo with marked studs -

[[file:secondlife-ups-MkII/studs-marked.jpg][file:secondlife-ups-MkII/thumb-studs-marked.jpg]]

Thoroughly deburr the corners of the drilled holes with a deburring tool or a Dremel. Leftover burrs can damage a cell's insulation sleeve and cause a short.
Drill with a 5mm metal drill
Drill from the bottom of the case
Use a puncturing tool for easier drilling. A cheap one can be bought for 2-3 EUR.
Support the chassis with 40mmx40mm wood cubes to prevent bending

- photo with studs removed -

[[file:secondlife-ups-MkII/studs-removed.jpg][file:secondlife-ups-MkII/thumb-studs-removed.jpg]]

*** Mounting the main battery fuse


- main battery fuse marked -

[[file:secondlife-ups-MkII/fuse-socket-marked.jpg][file:secondlife-ups-MkII/thumb-fuse-socket-marked.jpg]]

- main battery fuse mounted

M4 screws were used for mounting, 22mm hole was drilled with a step drill. 
remember about lubricant, my [[https://www.metabo.com/com/en/tools/cordless-tools/screwdriving-drilling-chiselling-stirring/cordless-drills-screwdrivers/powermaxx-bs-12-bl-q-601045800-cordless-drill-screwdriver.html?listtype=search&searchparam=BS%2B12][Metabo BS 12 BL Q]] 20 Nm cordless drill was struggling a bit but you can do it with some patience
deburr the holes

[[file:secondlife-ups-MkII/fuse-socket-mounted1.jpg][file:secondlife-ups-MkII/thumb-fuse-socket-mounted1.jpg]]

[[file:secondlife-ups-MkII/fuse-socket-mounted2.jpg][file:secondlife-ups-MkII/thumb-fuse-socket-mounted2.jpg]]

** Battery assembly
*** Plan detailed battery placement and wiring

0- internal screws and clearances
- cable management

*** Cell gathering, testing and ma

*** Nickel strip thickness calculations

The battery will be built by welding nickel strips onto the cells in a certain pattern. The basis of the calculation of the required width of the nickel strips is the
following table. Unfortunately the exact methodology of how these numbers have been obtained is unclear but it's the best data I have found so far:

#+CAPTION: Nickel strip current carrying capacity 
|--------------+-------------+----------------+----------|
| Strip size   | Optimal [A] | Acceptable [A] | Poor [A] |
|--------------+-------------+----------------+----------|
|              | <c>         | <c>            | <c>      |
| 0.1mm x 5mm  | < 2.1       | 3.0            | > 4.2    |
| 0.1mm x 7mm  | < 3.0       | 4.5            | > 6.0    |
| 0.15mm x 7mm | < 4.7       | 7.0            | > 9.4    |
| 0.2mm x 7mm  | < 6.4       | 9.6            | > 12.8   |
| 0.3mm x 7mm  | < 10.0      | 15             | > 20.0   |
|--------------+-------------+----------------+----------|

[[https://cellsaviors.com/blog/how-to-size-wire-fuses-and-nickel-strip-for-a-lithium-battery-pack][Reference]]

As previously calculated, the maximum battery current will be around 30A during discharge therefore the current collectors at the battery terminals need to use 
two 0.3mm strips. Additionally, the strips that I am using are 8mm wide not 7mm wide giving some headroom for current capacity.

*** Welding the cells

The general approach is to connect the cells together with 8mm wide nickel strips using spot welding. In order to facilitate cell charge verification and equalization
within each of the 24P blocks first only one side of the block (the positive cell terminals in my case) is welded first, then cells charge is equalized and then the second 
cell terminals (negative cell terminals in my case) are welded together. Most welds are performed with 0.1mm and 0.12mm nickel strips but the terminal connections for the 
entire battery are built out of 0.3mm strips for designed current capacity.

- welding jig -

file:secondlife-ups-MkII/welding-jig.svg

- cells in welding jig -

The cells are first connected together 
[[file:secondlife-ups-MkII/cells-inside-jig.jpg][file:secondlife-ups-MkII/thumb-cells-inside-jig.jpg]]

The strip can be savely secured to the cells by using small magnets:

[[file:secondlife-ups-MkII/cell-tacking-magnets.jpg][file:secondlife-ups-MkII/thumb-cell-tacking-magnets.jpg]]

The strips are welded to the cells using a [[https://www.keenlab.de/][kWeld from Keenlab]] spot welder powered by a [[https://www.lrp.cc/en/product/hv-stock-spec-graphene-3-7300mah-hardcase-battery-76v-lipo-130c65c-1/][HV Stock Spec GRAPHENE-3 7300mAh Hardcase battery - 7.6V LiPo - 130C/65C]]. The effect
of welding both 0.1mm and 0.12mm thickness strips that connect the cells 

[[file:secondlife-ups-MkII/cells-welded-first-side.jpg][file:secondlife-ups-MkII/thumb-cells-welded-first-side.jpg]]

- equalizing -

The cells in all four 24P blocks are first checked with a voltmeter and if some of them have self-discharged below 4V they are charged individually. I use a DIY "charger"
which connects together 5 cheap "Li-Ion charger" modules based around the popular [[https://octopart.com/tp4056x-42-esop8-toppower-125439323?r=sp][TP4056]] chip. 

[[file:secondlife-ups-MkII/cells-equalized.jpg][file:secondlife-ups-MkII/thumb-cells-equalized.jpg]]

- terminal strips -

The strips used for terminal current collectors (providing the positive and negative for the entire battery) are welded longer than the length of the block to be bent together
and soldered to 4mm² wires.

[[file:secondlife-ups-MkII/terminal-current-collectors.jpg][file:secondlife-ups-MkII/thumb-terminal-current-collectors.jpg]]

[[file:secondlife-ups-MkII/terminal-wire-soldered.jpg][file:secondlife-ups-MkII/thumb-terminal-wire-soldered.jpg]]


After all blocks are welded and equalized they are put side-by-side in the welding jig and connected with more 0.1mm/0.12mm strips. This process can be seen below. Care needs
to be taken at this stage in order to properly orient the blocks taking into account the polarity as well as final wiring in the enclosure.

*** Attaching thermal sensors and voltage sense wires

*** Forming and securing the battery

*** Testing the battery

** Front panel assembly

The front panel assembly is built using modules 
Materials
- module boards
- 4 x M2.5x8mm screws and nuts per module

Each module covers the space of 4x2 RJ45 ports which is a typical cutout size for switches.

Tools needed:
- drill press (optimal)
- hand drill (suboptimal but usable)
- dremel or [[https://www.mcmaster.com/products/deburring-tools/][deburring tool]]
- center punch
- sharp pen for hole marking

Steps
Tips: Blank PCBs are good for alingnment because lining them up is easier

Lay out the module PCBs on the front panel
[[file:secondlife-ups-MkII/layout.jpg][file:secondlife-ups-MkII/thumb-layout.jpg]]

Drill with 3mm drill

Mount the PCBs one by one for best alignment

Use M2.5 screws for assembly

Holes need to be deburred with a deburring tool or dremel

The module PCBs can be placed inside or outside the front panel assembly depending on how the front panel latches onto the rest of the enclosure.

[[file:secondlife-ups-MkII/mount-inside.jpg][file:secondlife-ups-MkII/thumb-mount-inside.jpg]]

[[file:secondlife-ups-MkII/mount-outside.jpg][file:secondlife-ups-MkII/thumb-mount-outside.jpg]]



* Bill of Materials

- Shipping costs and taxes are not included.
- All prices are in EUR.

#+CAPTION: Bill of Materials
|-------------------------------------+---------------------------+------------------------------------------------------------------------------------------------------------------------------+------+--------+----------------------+------------------+------------------+---------------------|
| Item                                | Type                      | Description                                                                                                                  | Unit | Amount | Price per unit [EUR] | Line total [EUR] | Purchase date    | Notes               |
|-------------------------------------+---------------------------+------------------------------------------------------------------------------------------------------------------------------+------+--------+----------------------+------------------+------------------+---------------------|
| Battery cells                       | Various                   | Li-Ion 3.6V 18650 Cells                                                                                                      | pcs  |     48 |                    0 |                0 | N/A              | From existing stock |
| AC Power supply                     | [[https://www.aliexpress.com/item/32950139524.html][Coleen CB-400W-24V]]        | AC 230V, 24V/16.6A                                                                                                           | pcs  |      1 |                 19.9 |             19.9 | <2023-04-07 pią> |                     |
| Main battery switch                 | [[https://www.tme.eu/pl/katalog/przelaczniki-typu-rocker_100054/?art=R13133L01BBRL2][R13133L01BBRL2]]            | ROCKER; SPST; Poz: 2; ON-OFF; 30A/24VDC; czarny; LED; 12VDC; -20÷85°C                                                        | pcs  |      1 |                 2.19 |             2.19 | <2023-04-07 pią> |                     |
| Battery fuse socket                 | [[https://www.tme.eu/pl/katalog/gniazda-bezpiecznikowe-na-panel_113040/?art=PMG-KB-01-Q2S][PMG-KB-01-Q2S]]             | Fuse holder; 10.3x38.1mm; 30A; on panel; Cutout: Ø22.4mm; UL94V-1                                                            | pcs  |      1 |                 8.77 |             8.77 | <2023-04-07 pią> |                     |
| Battery fuse                        | [[https://www.tme.eu/pl/en/details/0090.0030/fuses-10-3x38mm-fast/schurter/][0090.0030 SCHURTER]]        | Fuse: fuse; gPV; 30A; 1kVDC; ceramic,cylindrical,industrial; ASO                                                             | pcs  |      1 |                 8.68 |             8.68 | <2023-07-13>     |                     |
| 12V Buck Converter                  | [[https://www.aliexpress.com/item/1005002603980974.html][DN121]]                     | VOLTAGE REGULATOR 24V to 12V 10A DC/DC Converter Step Down Voltage Transformer Buck Regulator Voltage for Solar for LED      | pcs  |      1 |                 8.62 |             8.62 | <2023-03-15 śro> |                     |
| CC/CV Charger                       | [[https://www.aliexpress.com/item/1005004153906058.html][XL4015]]                    | Efficient Adjustable 5A DC-DC Buck Module Constant Current Voltage Regulator Step Down Converter Charging Board 5V 12V 24V   | pcs  |      1 |                 2.31 |             2.31 | <2023-03-15 śro> |                     |
| Battery Management System           | [[https://www.aliexpress.com/item/1005002066419577.html][EGBO Store 4S/100A]]        | 3s 4s 5s Bms 12v 16.8v 21v 3.7v 100a Li-ion Lmo Ternary Lithium Battery Protection Circuit Board Li-polymer Balance Charging | pcs  |      1 |                 2.27 |             2.27 | <2023-05-07>     |                     |
| Pluggable terminal blocks (sockets) | [[https://www.tme.eu/Document/83e7173fe653a2d0e44585e87978945b/opr014R8.pdf][15EDGVC-3.5-02P-14-00A(H)]] | Pluggable terminal block; 3.5mm; ways: 2; straight; socket; male                                                             | pcs  |     16 |                 0.19 |             3.04 | <2023-04-07 pią> |                     |
| Pluggable terminal blocks (plugs)   | [[https://www.tme.eu/Document/580c900c7460c0af0ff973aec46ec4f5/15edgk.pdf][15EDGK-3.5-02P-14-00AH]]    | Pluggable terminal block; 3.5mm; ways: 2; straight; plug; female                                                             | pcs  |     20 |                 0.42 |              8.4 | <2023-04-07 pią> | 4 spare units       |
|-------------------------------------+---------------------------+------------------------------------------------------------------------------------------------------------------------------+------+--------+----------------------+------------------+------------------+---------------------|
| Total                               |                           |                                                                                                                              |      |        |                      |            64.18 |                  |                     |
|-------------------------------------+---------------------------+------------------------------------------------------------------------------------------------------------------------------+------+--------+----------------------+------------------+------------------+---------------------|
#+TBLFM: $7=$5 * $6::@>$7=vsum(@II..@III)



#+TITLE: Second Life UPS Mark II

* Introduction

The Secondlife UPS Mark II was envisioned as a successor to the first [[file:secondlife-ups.org]] model with the general changes as below

- increased battery capacity
- increased power budget
- circuit simplification
- modularity
- improved load connectors
- various other usability improvements (for example moving the fuses to the front of the enclosure)
- better documentation 

The basic premise is to provide a UPS which instead of 230V AC can provide typical low voltages suitable for powering of sensors, routers, 802.11 access points modems, switches, embedded systems (like a Raspberry Pi) and other small devices. It's design is focused around a few stabilised voltage buses providing 12V and 5V respectively as well as a "direct" rail (labelled later as V_rail) which is connected directly to the battery or AC power supply. The peculiarity of this bus is that the voltage on it has a significant swing - from 11.2 V when operating on an almost depleted battery towards 24V when operating on AC power.

*** More battery capacity

In order to provide more power as well as longer runtime, the UPS will use a recycled broken [[https://wikidevi.wi-cat.ru/Netgear_GS748T_v4][Netgear GS748T]] switch.

The new battery pack is 4S24P.

Battery capacity is 300 Wh, 

*** More power

The list of equipment in my home rack has changed, some equipment has been replaced, there is some new equipment as well. Some of the new equipment will be powered by wide input range DC-DC converters so they can be powered directly from the battery rail (V_rail). I measured the amount of current draw during normal operation and came up with the following estimates:

As the voltage on the V_batt bus is not constant and changes from 11.2V when operating on a discharged battery and 24V when operating on AC its more useful to specify it's performance in terms of power not current.

#+CAPTION: Devices connected to the UPS
#+ATTR_HTML: :border 2 :rules all :frame border
#+NAME: devices
|---------------------------+----------------------------+-----------------------+----------------------+-----------------------------+------------------------+-----------------------------------------------------------------------------------------------------------|
| Device                    | 12V Current [A] (measured) | 12V Current [A] (max) | 5V Current [A] (max) | V_rail power [W] (measured) | V_rail power [W] (max) | Notes                                                                                                     |
|---------------------------+----------------------------+-----------------------+----------------------+-----------------------------+------------------------+-----------------------------------------------------------------------------------------------------------|
| New Router                |                            |                     5 |                      |                             |                        | Axiomtek NA342                                                                                            |
| New GPON Modem            |                            |                   0.5 |                      |                             |                        |                                                                                                           |
| Core Ethernet switch      |                       1.33 |                     4 |                      |                             |                        |                                                                                                           |
| Planet GSD-800S switch    |                            |                       |                      |                             |                     21 | PoE injected                                                                                              |
| Ubiquity Unify AC Lite AP |                       0.16 |                  0.54 |                      |                             |                        | Via boost converter and PoE injected, rated at 6.5 W (see [[https://dl.ui.com/datasheets/unifi/UniFi_AC_APs_DS.pdf][datasheet]]), passive 24V PoE Mode B (230V/0.02A) |
| Raspberry Pi              |                            |                       |                  2.1 |                             |                        |                                                                                                           |
| Gate magnetic lock        |                       0.25 |                       |                      |                             |                        |                                                                                                           |
| [[https://wikidevi.wi-cat.ru/Netgear_ReadyNAS_3138][Network Attached Storage]]  |                            |                       |                      |                          40 |                    100 | Built-in ATX power supply is 180W but real power draw has not exceeded 100W                               |
| Network Video Recorder    |                            |                       |                      |                             |                     40 | Boost converter to 48V                                                                                    |
| Security Cameras (total)  |                       0.75 |                       |                      |                             |                        |                                                                                                           |
|---------------------------+----------------------------+-----------------------+----------------------+-----------------------------+------------------------+-----------------------------------------------------------------------------------------------------------|
| Total                     |                       2.49 |                 10.04 |                  2.1 |                          40 |                    161 |                                                                                                           |
|---------------------------+----------------------------+-----------------------+----------------------+-----------------------------+------------------------+-----------------------------------------------------------------------------------------------------------|
#+TBLFM: @>$2=vsum(@II..@III)::@>$3=vsum(@II..@III)::@>$4=vsum(@II..@III)::@>$5=vsum(@II..@III)::@>$6=vsum(@II..@III)

*** Capacity planning for power buses

We take into account an efficiency of 0.8 for the buck converters and assume that the lowest voltage seen by the system will be 11.2V which corresponds to the BMS cutoff voltage of 2.8V per cell.

#+CAPTION: Maximum current and power values for each bus
#+NAME: bus_load_capacity
|---+-------------------------------+-------------+-----------------+---------------+-------------------------------+-----------------------------|
| $ | minimum_battery_voltage=11.2  |             |                 |               |                               |                             |
| $ | voltage_on_ac=24              |             |                 |               |                               |                             |
| $ | buck_converter_efficiency=0.8 |             |                 |               |                               |                             |
|---+-------------------------------+-------------+-----------------+---------------+-------------------------------+-----------------------------|
|   | Bus                           | Voltage [V] | Max current [A] | Max power [W] | V_rail load on batt power [A] | V_rail load on AC power [A] |
|---+-------------------------------+-------------+-----------------+---------------+-------------------------------+-----------------------------|
| # | 12 V                          |          12 |           10.04 |        120.48 |                     13.446429 |                        5.02 |
| # | 5 V                           |           5 |             2.1 |          10.5 |                      1.171875 |                      0.4375 |
| # | Direct                        |             |                 |           161 |                        14.375 |                   6.7083333 |
|---+-------------------------------+-------------+-----------------+---------------+-------------------------------+-----------------------------|
| # | Total                         |             |                 |        291.98 |                     28.993304 |                     5.50125 |
|---+-------------------------------+-------------+-----------------+---------------+-------------------------------+-----------------------------|
#+TBLFM: @5$4=remote(devices, @>$3)::@6$4=remote(devices, @>$4)::@7$5=remote(devices, @>$6)
#+TBLFM: @5$5=$3 * $4::@6$5=$3 * $4::$7=$5 / $voltage_on_ac
#+TBLFM: @5$6=$-1 / $buck_converter_efficiency / $minimum_battery_voltage::@6$6=$-1 / $buck_converter_efficiency / $minimum_battery_voltage::@7$6=$-1 / $minimum_battery_voltage
#+TBLFM: @>$5=vsum(@III..@IIII)::@>$6=vsum(@III..@IIII)

The above calculations allow us to select proper fuses for the different buses. It can also be seen that an AC power supply with at least 300W is needed to power the loads with some room needed to charge the battery. For this reason a 400W power supply has been selected (see summary in BOM).

*** Ideal Diode circuit

Instead of the previously used relay-based power path switching scheme a solid-state power switch based on MOSFETs driven by the LTC4416 PowerPath controller will be used.

*** Battery pack 

*** Modularity

**** Fanout boards and fuse boards

**** Improved load connectors


* Overall schematics

[[file:secondlife-ups-MkII/hw.svg]]


* Bill of Materials

- Shipping costs and taxes are not included.
- All prices are in EUR.

#+CAPTION: Bill of Materials
|-------------------------------------+---------------------------+----------------------------------------------------------------------------------------------------------------------------+------+--------+----------------------+------------------+------------------+---------------------|
| Item                                | Type                      | Description                                                                                                                | Unit | Amount | Price per unit [EUR] | Line total [EUR] | Purchase date    | Notes               |
|-------------------------------------+---------------------------+----------------------------------------------------------------------------------------------------------------------------+------+--------+----------------------+------------------+------------------+---------------------|
| Battery cells                       | Various                   | Li-Ion 3.6V 18650 Cells                                                                                                    | pcs  |     48 |                    0 |                0 | N/A              | From existing stock |
| AC Power supply                     | [[https://www.aliexpress.com/item/32950139524.html][Coleen CB-400W-24V]]        | AC 230V, 24V/16.6A                                                                                                         | pcs  |      1 |                 19.9 |             19.9 | <2023-04-07 pią> |                     |
| Main battery switch                 | [[https://www.tme.eu/pl/katalog/przelaczniki-typu-rocker_100054/?art=R13133L01BBRL2][R13133L01BBRL2]]            | ROCKER; SPST; Poz: 2; ON-OFF; 30A/24VDC; czarny; LED; 12VDC; -20÷85°C                                                      | pcs  |      1 |                 2.19 |             2.19 | <2023-04-07 pią> |                     |
| Main fuse socket                    | [[https://www.tme.eu/pl/katalog/gniazda-bezpiecznikowe-na-panel_113040/?art=PMG-KB-01-Q2S][PMG-KB-01-Q2S]]             | Gniazdo; 10,3x38,1mm; 30A; na panel; Otw: Ø22,4mm; UL94V-1; 600VAC                                                         | pcs  |      1 |                 8.77 |             8.77 | <2023-04-07 pią> |                     |
| 12V Buck Converter                  | [[https://www.aliexpress.com/item/1005002603980974.html][DN121]]                     | VOLTAGE REGULATOR 24V to 12V 10A DC/DC Converter Step Down Voltage Transformer Buck Regulator Voltage for Solar for LED    | pcs  |      1 |                 8.62 |             8.62 | <2023-03-15 śro> |                     |
| CC/CV Charger                       | [[https://www.aliexpress.com/item/1005004153906058.html][XL4015]]                    | Efficient Adjustable 5A DC-DC Buck Module Constant Current Voltage Regulator Step Down Converter Charging Board 5V 12V 24V | pcs  |      1 |                 2.31 |             2.31 | <2023-03-15 śro> |                     |
| Pluggable terminal blocks (sockets) | [[https://www.tme.eu/Document/83e7173fe653a2d0e44585e87978945b/opr014R8.pdf][15EDGVC-3.5-02P-14-00A(H)]] | Pluggable terminal block; 3.5mm; ways: 2; straight; socket; male                                                           | pcs  |     16 |                 0.19 |             3.04 | <2023-04-07 pią> |                     |
| Pluggable terminal blocks (plugs)   | [[https://www.tme.eu/Document/580c900c7460c0af0ff973aec46ec4f5/15edgk.pdf][15EDGK-3.5-02P-14-00AH]]    | Pluggable terminal block; 3.5mm; ways: 2; straight; plug; female                                                           | pcs  |     20 |                 0.42 |              8.4 | <2023-04-07 pią> | 4 spare units       |
|-------------------------------------+---------------------------+----------------------------------------------------------------------------------------------------------------------------+------+--------+----------------------+------------------+------------------+---------------------|
| Total                               |                           |                                                                                                                            |      |        |                      |            56.63 |                  |                     |
|-------------------------------------+---------------------------+----------------------------------------------------------------------------------------------------------------------------+------+--------+----------------------+------------------+------------------+---------------------|
#+TBLFM: $7=$5 * $6::@>$7=vsum(@II..@III)



